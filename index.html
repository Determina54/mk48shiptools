<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆ¹åªå»ºé€ å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #1e1e2e;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 350px;
            background-color: #252526;
            border-right: 1px solid #3e3e42;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #1e1e1e;
        }
        
        #coordinateSystem {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 20; /* åæ ‡ç³»åœ¨ä¸­é—´å±‚ */
        }
        
        .toolbar {
            display: flex;
            padding: 10px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            gap: 10px;
        }
        
        .tool-btn {
            background-color: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .tool-btn:hover {
            background-color: #1177bb;
        }
        
        .tool-btn.active {
            background-color: #007acc;
        }
        
        .tool-btn.locked {
            background-color: #555555;
        }
        
        .tool-btn.locked:hover {
            background-color: #666666;
        }
        
        .tool-btn.secondary {
            background-color: #3a3a3a;
        }
        
        .tool-btn.secondary:hover {
            background-color: #4a4a4a;
        }
        
        .panel {
            background-color: #2d2d30;
            border-radius: 5px;
            padding: 15px;
        }
        
        .panel h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #cccccc;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .module-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 5px;
            background-color: #1e1e1e;
        }
        
        .module-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #252526;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .module-item:hover {
            background-color: #2a2d2e;
        }
        
        .module-item.selected {
            background-color: #37373d;
            border-left: 3px solid #007acc;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 30;
        }
        
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            z-index: 30;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 30; /* æ­¦å™¨è£…å¤‡ç‚¹ä½åœ¨æœ€ä¸Šå±‚ */
        }
        
        .point-label {
            position: absolute;
            font-size: 12px;
            transform: translate(10px, -10px);
            pointer-events: none;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
            z-index: 30;
        }
        
        .ship-image {
            position: absolute;
            pointer-events: auto; /* å…è®¸å›¾ç‰‡æ¥å—é¼ æ ‡äº‹ä»¶ */
            transform-origin: center center;
            z-index: 10; /* å›¾ç‰‡åœ¨æœ€åº•å±‚ */
        }
        
        .code-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            overflow-y: auto;
            max-height: 300px;
            white-space: pre-wrap;
        }
        
        .module-editor {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #3e3e42;
        }
        
        .module-editor h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #cccccc;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 8px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            width: auto;
            margin-right: 8px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .module-type-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .module-type-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .module-type-tab.active {
            border-bottom: 2px solid #007acc;
            color: #007acc;
        }
        
        .select-with-custom {
            display: flex;
            gap: 5px;
        }
        
        .select-with-custom select {
            flex: 3;
        }
        
        .select-with-custom input {
            flex: 2;
        }
        
        .dimension-info {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .dimension-info div {
            margin-bottom: 3px;
        }
        
        .dimension-info .file-dim {
            color: #888888;
        }
        
        .dimension-info .content-dim {
            color: #4ec9b0;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #007acc;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .warning-message {
            background-color: #3a2c1e;
            border: 1px solid #8a6d3b;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #f0ad4e;
        }
        
        .success-message {
            background-color: #1e3a2c;
            border: 1px solid #3b8a6d;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #4ef0ad;
        }
        
        .detection-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background-color: #1e1e1e;
            border-radius: 4px;
            border: 1px solid #3e3e42;
        }
        
        .detection-controls h4 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #cccccc;
        }
        
        .sensitivity-slider {
            width: 100%;
            margin: 5px 0;
        }
        
        .sensitivity-value {
            font-size: 12px;
            color: #888888;
            text-align: right;
        }
        
        .center-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .center-controls button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="panel">
                <h3>èˆ¹åªä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="shipName">èˆ¹åªåç§°</label>
                    <input type="text" id="shipName" value="Iowa">
                </div>
                <div class="form-group">
                    <label for="shipClass">èˆ¹åªç±»å‹</label>
                    <div class="select-with-custom">
                        <select id="shipClass">
                            <option value="Battleship">æˆ˜åˆ—èˆ°</option>
                            <option value="Cruiser">å·¡æ´‹èˆ°</option>
                            <option value="Destroyer">é©±é€èˆ°</option>
                            <option value="Carrier">èˆªç©ºæ¯èˆ°</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="text" id="shipClassCustom" placeholder="è‡ªå®šä¹‰ç±»å‹" style="display: none;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="shipLevel">ç­‰çº§</label>
                    <input type="number" id="shipLevel" value="10" min="1" max="20">
                </div>
            </div>
            
            <div class="panel">
                <h3>èˆ¹åªå°ºå¯¸</h3>
                <div class="form-group">
                    <label for="shipLength">é•¿åº¦ (ç±³)</label>
                    <input type="number" id="shipLength" value="270.4" step="0.1">
                </div>
                <div class="form-group">
                    <label for="shipWidth">å®½åº¦ (ç±³)</label>
                    <input type="number" id="shipWidth" value="32.74" step="0.1">
                </div>
                <div class="form-group">
                    <label for="shipDraft">åƒæ°´æ·±åº¦ (ç±³)</label>
                    <input type="number" id="shipDraft" value="12" step="0.1">
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šå›¾ç‰‡å°ºå¯¸æ§åˆ¶é¢æ¿ -->
            <div class="panel" id="imageControlPanel" style="display: none;">
                <h3>å›¾ç‰‡å°ºå¯¸æ§åˆ¶</h3>
                
                <div class="dimension-info" id="dimensionInfo">
                    <div class="file-dim">æ–‡ä»¶å°ºå¯¸: <span id="fileDimensions">-</span> åƒç´ </div>
                    <div class="content-dim">å†…å®¹å°ºå¯¸: <span id="contentDimensions">-</span> åƒç´ </div>
                    <div>å†…å®¹ä¸­å¿ƒåç§»: <span id="contentOffset">(0, 0)</span> åƒç´ </div>
                    <div>é€æ˜åŒºåŸŸå æ¯”: <span id="transparencyRatio">-</span>%</div>
                </div>
                
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="mapWholeImage" name="mappingMode" value="whole" checked>
                        <label for="mapWholeImage">æ˜ å°„æ•´ä¸ªæ–‡ä»¶å°ºå¯¸</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="mapContentOnly" name="mappingMode" value="content">
                        <label for="mapContentOnly">ä»…æ˜ å°„å†…å®¹åŒºåŸŸ</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="imageLength">å›¾ç‰‡ä»£è¡¨é•¿åº¦ (ç±³)</label>
                    <input type="number" id="imageLength" value="270.4" step="0.1">
                </div>
                <div class="form-group">
                    <label for="imageWidth">å›¾ç‰‡ä»£è¡¨å®½åº¦ (ç±³)</label>
                    <input type="number" id="imageWidth" value="32.74" step="0.1">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="lockAspectRatio" checked>
                    <label for="lockAspectRatio">ä¿æŒå®½é«˜æ¯”</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="autoFitImage" checked>
                    <label for="autoFitImage">è‡ªåŠ¨é€‚åº”åæ ‡ç³»</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="centerImage" checked>
                    <label for="centerImage">å›¾ç‰‡å±…ä¸­(ä¸­å¿ƒä¸ºåŸç‚¹)</label>
                </div>
                
                <!-- æ–°å¢ï¼šæ£€æµ‹æ§åˆ¶ -->
                <div class="detection-controls">
                    <h4>æ£€æµ‹è®¾ç½®</h4>
                    <div>
                        <label for="sensitivitySlider">æ£€æµ‹çµæ•åº¦: <span id="sensitivityValue">30</span></label>
                        <input type="range" id="sensitivitySlider" class="sensitivity-slider" min="0" max="255" value="30">
                        <div class="sensitivity-value">(å€¼è¶Šå°è¶Šæ•æ„Ÿ)</div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="detectEdges" checked>
                        <label for="detectEdges">æ£€æµ‹è¾¹ç¼˜é€æ˜åƒç´ </label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoCenterContent" checked>
                        <label for="autoCenterContent">è‡ªåŠ¨å°†å†…å®¹ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹</label>
                    </div>
                </div>
                
                <div class="center-controls">
                    <button class="tool-btn" id="centerToOriginBtn" style="flex: 1;">ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹</button>
                    <button class="tool-btn" id="showContentBoundsBtn" style="flex: 1;">æ˜¾ç¤ºå†…å®¹è¾¹ç•Œ</button>
                </div>
                
                <button class="tool-btn" id="autoDetectBtn" style="width: 100%; margin-top: 5px;">è‡ªåŠ¨æ£€æµ‹å†…å®¹è¾¹ç•Œ</button>
                <button class="tool-btn" id="resetImageSizeBtn" style="width: 100%; margin-top: 10px;">é‡ç½®å›¾ç‰‡å°ºå¯¸</button>
            </div>
            
            <div class="panel">
                <h3>æ¨¡å—ç®¡ç†</h3>
                <div class="module-type-tabs">
                    <div class="module-type-tab active" data-type="armament">æ­¦å™¨</div>
                    <div class="module-type-tab" data-type="turret">ç‚®å¡”</div>
                </div>
                
                <div class="module-list" id="moduleList">
                    <!-- æ¨¡å—åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button class="tool-btn" id="addModuleBtn" style="width: 100%; margin-top: 10px;">æ·»åŠ æ¨¡å—</button>
                
                <div class="module-editor hidden" id="moduleEditor">
                    <h4 id="editorTitle">ç¼–è¾‘æ¨¡å—</h4>
                    
                    <!-- æ­¦å™¨ç¼–è¾‘å™¨ -->
                    <div id="armamentEditor">
                        <div class="form-group">
                            <label for="weaponName">æ­¦å™¨åç§°</label>
                            <input type="text" id="weaponName" value="Tomahawk">
                        </div>
                        <div class="form-group">
                            <label for="weaponForward">å‰å‘ä½ç½®</label>
                            <input type="number" id="weaponForward" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="weaponSide">ä¾§å‘ä½ç½®</label>
                            <input type="number" id="weaponSide" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="weaponAngle">è§’åº¦</label>
                            <input type="number" id="weaponAngle" value="-90" step="1">
                        </div>
                        <div class="form-group">
                            <label for="weaponCount">æ•°é‡</label>
                            <input type="number" id="weaponCount" value="2" min="1" step="1">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="weaponSymmetrical">
                            <label for="weaponSymmetrical">å¯¹ç§°</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="weaponHidden">
                            <label for="weaponHidden">éšè—</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="weaponExternal">
                            <label for="weaponExternal">å¤–éƒ¨</label>
                        </div>
                    </div>
                    
                    <!-- ç‚®å¡”ç¼–è¾‘å™¨ -->
                    <div id="turretEditor" class="hidden">
                        <div class="form-group">
                            <label for="turretName">ç‚®å¡”åç§°</label>
                            <input type="text" id="turretName" value="Mark7">
                        </div>
                        <div class="form-group">
                            <label for="turretForward">å‰å‘ä½ç½®</label>
                            <input type="number" id="turretForward" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="turretSide">ä¾§å‘ä½ç½®</label>
                            <input type="number" id="turretSide" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="turretAngle">è§’åº¦</label>
                            <input type="number" id="turretAngle" value="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="turretSpeed">è½¬é€Ÿ</label>
                            <select id="turretSpeed">
                                <option value="slow">æ…¢é€Ÿ</option>
                                <option value="medium">ä¸­é€Ÿ</option>
                                <option value="fast">å¿«é€Ÿ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="turretAzimuthB">æ–¹ä½è§’B</label>
                            <input type="number" id="turretAzimuthB" value="20" step="1">
                        </div>
                    </div>
                    
                    <button class="tool-btn" id="saveModuleBtn" style="width: 100%; margin-top: 10px;">ä¿å­˜ä¿®æ”¹</button>
                    <button class="tool-btn" id="deleteModuleBtn" style="width: 100%; margin-top: 5px; background-color: #c42b1c;">åˆ é™¤æ¨¡å—</button>
                </div>
            </div>
            
            <div class="panel">
                <h3>ç”Ÿæˆä»£ç </h3>
                <button class="tool-btn" id="generateCodeBtn" style="width: 100%; margin-bottom: 10px;">ç”Ÿæˆèˆ¹åªä»£ç </button>
                <div class="code-output" id="codeOutput">
                    // ç”Ÿæˆçš„ä»£ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="toolbar">
                <button class="tool-btn" id="importImageBtn">å¯¼å…¥å›¾ç‰‡</button>
                <button class="tool-btn active" id="addArmamentBtn">æ·»åŠ æ­¦å™¨</button>
                <button class="tool-btn" id="addTurretBtn">æ·»åŠ ç‚®å¡”</button>
                <button class="tool-btn" id="clearAllBtn">æ¸…é™¤æ‰€æœ‰</button>
                <div style="flex: 1;"></div>
                <!-- æ–°å¢ï¼šå›¾ç‰‡å›ºå®šæŒ‰é’® -->
                <button class="tool-btn" id="lockImageBtn">ğŸ”“ è§£é”å›¾ç‰‡</button>
                <button class="tool-btn" id="imageScaleUpBtn">æ”¾å¤§å›¾ç‰‡</button>
                <button class="tool-btn" id="imageScaleDownBtn">ç¼©å°å›¾ç‰‡</button>
                <button class="tool-btn" id="imageResetBtn">é‡ç½®å›¾ç‰‡</button>
            </div>
            
            <div class="canvas-container">
                <!-- ä¿®æ”¹å±‚çº§é¡ºåºï¼šå›¾ç‰‡åœ¨æœ€åº•å±‚ -->
                <img id="shipImage" class="ship-image" style="display: none;" crossorigin="anonymous">
                <canvas id="coordinateSystem"></canvas>
                <!-- æ­¦å™¨è£…å¤‡ç‚¹ä½é€šè¿‡Canvasç»˜åˆ¶ï¼Œä½äºæœ€ä¸Šå±‚ -->
                <div id="infoPanel" class="info-panel">ç¼©æ”¾: 1.00x | åæ ‡: (0, 0)</div>
                <div class="control-panel">
                    <button class="control-btn" id="zoomIn">+</button>
                    <button class="control-btn" id="zoomOut">-</button>
                    <button class="control-btn" id="resetView">â†º</button>
                </div>
                
                <!-- åŠ è½½é®ç½© - åˆå§‹çŠ¶æ€å°±æ˜¯éšè—çš„ -->
                <div id="loadingOverlay" class="loading-overlay hidden">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åˆ†æå›¾ç‰‡å†…å®¹...</div>
                    <div id="loadingProgress" style="font-size: 12px; margin-top: 5px;">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–Canvaså…ƒç´ å’Œä¸Šä¸‹æ–‡
            const canvas = document.getElementById('coordinateSystem');
            if (!canvas) {
                console.error('æ— æ³•æ‰¾åˆ°canvaså…ƒç´ ');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const infoPanel = document.getElementById('infoPanel');
            const shipImage = document.getElementById('shipImage');
            const moduleList = document.getElementById('moduleList');
            const codeOutput = document.getElementById('codeOutput');
            const moduleEditor = document.getElementById('moduleEditor');
            const armamentEditor = document.getElementById('armamentEditor');
            const turretEditor = document.getElementById('turretEditor');
            const editorTitle = document.getElementById('editorTitle');
            const imageControlPanel = document.getElementById('imageControlPanel');
            const shipClassSelect = document.getElementById('shipClass');
            const shipClassCustom = document.getElementById('shipClassCustom');
            const lockImageBtn = document.getElementById('lockImageBtn');
            const imageResetBtn = document.getElementById('imageResetBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingProgress = document.getElementById('loadingProgress');
            const autoDetectBtn = document.getElementById('autoDetectBtn');
            const fileDimensions = document.getElementById('fileDimensions');
            const contentDimensions = document.getElementById('contentDimensions');
            const transparencyRatio = document.getElementById('transparencyRatio');
            const sensitivitySlider = document.getElementById('sensitivitySlider');
            const sensitivityValue = document.getElementById('sensitivityValue');
            const detectEdges = document.getElementById('detectEdges');
            const autoCenterContent = document.getElementById('autoCenterContent');
            const centerToOriginBtn = document.getElementById('centerToOriginBtn');
            const showContentBoundsBtn = document.getElementById('showContentBoundsBtn');
            const contentOffset = document.getElementById('contentOffset');

            // æ£€æŸ¥æ‰€æœ‰å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!ctx || !infoPanel || !shipImage || !moduleList || !codeOutput) {
                console.error('æ— æ³•æ‰¾åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }

            // åæ ‡ç³»é…ç½®
            const config = {
                scale: 50, // ç¼©æ”¾çº§åˆ«ï¼ˆåƒç´ /å•ä½ï¼‰
                offsetX: 0, // Xè½´åç§»
                offsetY: 0, // Yè½´åç§»
                modules: [], // å­˜å‚¨æ‰€æœ‰æ¨¡å—
                isDragging: false,
                lastX: 0,
                lastY: 0,
                gridSize: 1, // ç½‘æ ¼å¤§å°
                selectedModule: null, // å½“å‰é€‰ä¸­çš„æ¨¡å—
                
                // å›¾ç‰‡ç›¸å…³é…ç½®
                hasImage: false,
                imageScale: 1.0, // å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹ï¼ˆç›¸å¯¹äºåŸå§‹å›¾ç‰‡ï¼‰
                imageOffsetX: 0, // å›¾ç‰‡Xè½´åç§»ï¼ˆåƒç´ ï¼‰
                imageOffsetY: 0, // å›¾ç‰‡Yè½´åç§»ï¼ˆåƒç´ ï¼‰
                isImageDragging: false,
                lastImageX: 0,
                lastImageY: 0,
                imageLocked: false, // æ–°å¢ï¼šå›¾ç‰‡æ˜¯å¦è¢«é”å®š
                
                // å›¾ç‰‡å°ºå¯¸æ˜ å°„
                imageLength: 270.4, // å›¾ç‰‡ä»£è¡¨çš„å®é™…é•¿åº¦ï¼ˆç±³ï¼‰
                imageWidth: 32.74,  // å›¾ç‰‡ä»£è¡¨çš„å®é™…å®½åº¦ï¼ˆç±³ï¼‰
                imageOriginalWidth: 0, // å›¾ç‰‡åŸå§‹å®½åº¦ï¼ˆåƒç´ ï¼‰
                imageOriginalHeight: 0, // å›¾ç‰‡åŸå§‹é«˜åº¦ï¼ˆåƒç´ ï¼‰
                lockAspectRatio: true, // æ˜¯å¦é”å®šå®½é«˜æ¯”
                autoFitImage: true, // æ˜¯å¦è‡ªåŠ¨é€‚åº”åæ ‡ç³»
                centerImage: true, // å›¾ç‰‡æ˜¯å¦å±…ä¸­ï¼ˆä¸­å¿ƒä¸ºåŸç‚¹ï¼‰
                
                // æ–°å¢ï¼šå†…å®¹è¾¹ç•Œæ£€æµ‹
                mappingMode: 'whole', // 'whole' æˆ– 'content'
                contentBounds: null, // å†…å®¹è¾¹ç•Œä¿¡æ¯
                fileBounds: null, // æ–‡ä»¶è¾¹ç•Œä¿¡æ¯
                
                // æ£€æµ‹é…ç½®
                detectionSensitivity: 30, // æ£€æµ‹çµæ•åº¦ï¼ˆalphaé˜ˆå€¼ï¼‰
                detectEdgePixels: true, // æ˜¯å¦æ£€æµ‹è¾¹ç¼˜é€æ˜åƒç´ 
                autoCenterContent: true, // æ˜¯å¦è‡ªåŠ¨å°†å†…å®¹ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹
                
                // è§†è§‰è¾…åŠ©
                showContentBounds: false, // æ˜¯å¦æ˜¾ç¤ºå†…å®¹è¾¹ç•Œæ¡†
                
                currentModuleType: 'armament' // å½“å‰æ·»åŠ çš„æ¨¡å—ç±»å‹
            };

            // çµæ•åº¦æ»‘å—äº‹ä»¶
            if (sensitivitySlider && sensitivityValue) {
                sensitivitySlider.addEventListener('input', function() {
                    config.detectionSensitivity = parseInt(this.value);
                    sensitivityValue.textContent = config.detectionSensitivity;
                });
            }

            // è¾¹ç¼˜æ£€æµ‹å¤é€‰æ¡†äº‹ä»¶
            if (detectEdges) {
                detectEdges.addEventListener('change', function() {
                    config.detectEdgePixels = this.checked;
                });
            }

            // è‡ªåŠ¨å±…ä¸­å¤é€‰æ¡†äº‹ä»¶
            if (autoCenterContent) {
                autoCenterContent.addEventListener('change', function() {
                    config.autoCenterContent = this.checked;
                });
            }

            // ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹æŒ‰é’®äº‹ä»¶
            if (centerToOriginBtn) {
                centerToOriginBtn.addEventListener('click', centerContentToOrigin);
            }

            // æ˜¾ç¤ºå†…å®¹è¾¹ç•ŒæŒ‰é’®äº‹ä»¶
            if (showContentBoundsBtn) {
                showContentBoundsBtn.addEventListener('click', function() {
                    config.showContentBounds = !config.showContentBounds;
                    this.textContent = config.showContentBounds ? 'éšè—å†…å®¹è¾¹ç•Œ' : 'æ˜¾ç¤ºå†…å®¹è¾¹ç•Œ';
                    drawCoordinateSystem();
                });
            }

            // èˆ¹åªç±»å‹é€‰æ‹©äº‹ä»¶
            if (shipClassSelect) {
                shipClassSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        if (shipClassCustom) shipClassCustom.style.display = 'block';
                        if (shipClassCustom) shipClassCustom.value = '';
                    } else {
                        if (shipClassCustom) shipClassCustom.style.display = 'none';
                        if (shipClassCustom) shipClassCustom.value = '';
                    }
                });
            }

            // å›¾ç‰‡é”å®š/è§£é”æŒ‰é’®äº‹ä»¶
            if (lockImageBtn) {
                lockImageBtn.addEventListener('click', function() {
                    config.imageLocked = !config.imageLocked;
                    if (config.imageLocked) {
                        this.innerHTML = 'ğŸ”’ é”å®šå›¾ç‰‡';
                        this.classList.add('locked');
                        // å¦‚æœæ­£åœ¨æ‹–æ‹½å›¾ç‰‡ï¼Œç«‹å³åœæ­¢
                        config.isImageDragging = false;
                        // è®¾ç½®å›¾ç‰‡ä¸å¯ç‚¹å‡»
                        shipImage.style.pointerEvents = 'none';
                    } else {
                        this.innerHTML = 'ğŸ”“ è§£é”å›¾ç‰‡';
                        this.classList.remove('locked');
                        // è®¾ç½®å›¾ç‰‡å¯ç‚¹å‡»
                        shipImage.style.pointerEvents = 'auto';
                    }
                });
            }

            // æ˜ å°„æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('input[name="mappingMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    config.mappingMode = this.value;
                    if (config.hasImage) {
                        updateImageSizeFromMode();
                        calculateImageDisplaySize();
                        updateImagePosition();
                        
                        // å¦‚æœåˆ‡æ¢åˆ°å†…å®¹æ¨¡å¼ä¸”å¼€å¯äº†è‡ªåŠ¨å±…ä¸­ï¼Œè¿›è¡Œå±…ä¸­æ“ä½œ
                        if (config.mappingMode === 'content' && config.contentBounds && config.autoCenterContent) {
                            centerContentToOrigin();
                        }
                    }
                });
            });

            // è‡ªåŠ¨æ£€æµ‹å†…å®¹è¾¹ç•Œ - ä¿®å¤äº‹ä»¶å¤„ç†
            if (autoDetectBtn) {
                autoDetectBtn.addEventListener('click', function() {
                    if (!config.hasImage) {
                        alert('è¯·å…ˆå¯¼å…¥å›¾ç‰‡');
                        return;
                    }
                    
                    // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å®Œå…¨åŠ è½½
                    if (!config.imageOriginalWidth || !config.imageOriginalHeight) {
                        alert('å›¾ç‰‡å°šæœªå®Œå…¨åŠ è½½ï¼Œè¯·ç¨åå†è¯•');
                        return;
                    }
                    
                    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                    this.disabled = true;
                    this.textContent = 'åˆ†æä¸­...';
                    
                    detectContentBounds().finally(() => {
                        // é‡æ–°å¯ç”¨æŒ‰é’®
                        this.disabled = false;
                        this.textContent = 'è‡ªåŠ¨æ£€æµ‹å†…å®¹è¾¹ç•Œ';
                    });
                });
            }

            // å°†å†…å®¹ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹
            function centerContentToOrigin() {
                if (!config.hasImage || !config.contentBounds) {
                    alert('è¯·å…ˆæ£€æµ‹å›¾ç‰‡å†…å®¹è¾¹ç•Œ');
                    return;
                }
                
                // è®¡ç®—å†…å®¹åŒºåŸŸçš„ä¸­å¿ƒç‚¹ç›¸å¯¹äºæ–‡ä»¶ä¸­å¿ƒçš„åç§»
                const contentCenterX = config.contentBounds.minX + config.contentBounds.width / 2;
                const contentCenterY = config.contentBounds.minY + config.contentBounds.height / 2;
                
                const fileCenterX = config.imageOriginalWidth / 2;
                const fileCenterY = config.imageOriginalHeight / 2;
                
                // è®¡ç®—åç§»é‡ï¼Œä½¿å†…å®¹ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹
                const offsetX = fileCenterX - contentCenterX;
                const offsetY = fileCenterY - contentCenterY;
                
                // ä¿å­˜åç§»é‡åˆ°å†…å®¹è¾¹ç•Œä¿¡æ¯
                config.contentBounds.centerOffsetX = offsetX;
                config.contentBounds.centerOffsetY = offsetY;
                
                // è®¡ç®—ç›¸å¯¹äºåŸç‚¹çš„åç§»ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const relativeOffsetX = contentCenterX - fileCenterX;
                const relativeOffsetY = contentCenterY - fileCenterY;
                
                // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
                if (contentOffset) {
                    contentOffset.textContent = `(${Math.round(relativeOffsetX)}, ${Math.round(relativeOffsetY)})`;
                }
                
                // å¦‚æœå¼€å¯äº†è‡ªåŠ¨å±…ä¸­ï¼Œè°ƒæ•´å›¾ç‰‡åç§»
                if (config.autoCenterContent) {
                    // åº”ç”¨åç§»é‡åˆ°å›¾ç‰‡æ˜¾ç¤º
                    config.imageOffsetX += offsetX * config.imageScale;
                    config.imageOffsetY += offsetY * config.imageScale;
                    
                    updateImagePosition();
                    drawCoordinateSystem();
                    
                    console.log('å†…å®¹å·²å±…ä¸­åˆ°åŸç‚¹', {
                        contentCenter: {x: contentCenterX, y: contentCenterY},
                        fileCenter: {x: fileCenterX, y: fileCenterY},
                        offset: {x: offsetX, y: offsetY}
                    });
                    
                    alert(`å†…å®¹å·²å±…ä¸­åˆ°åŸç‚¹\nåç§»é‡: (${Math.round(relativeOffsetX)}, ${Math.round(relativeOffsetY)})åƒç´ `);
                }
            }

            // æ£€æµ‹å›¾ç‰‡å†…å®¹è¾¹ç•Œ - æ”¹è¿›ç‰ˆæœ¬
            async function detectContentBounds() {
                if (!config.hasImage || !config.imageOriginalWidth || !config.imageOriginalHeight) {
                    alert('å›¾ç‰‡ä¿¡æ¯ä¸å®Œæ•´');
                    return;
                }
                
                console.log('å¼€å§‹åˆ†æå›¾ç‰‡å†…å®¹è¾¹ç•Œ...');
                
                // æ˜¾ç¤ºåŠ è½½é®ç½©
                if (loadingOverlay) loadingOverlay.classList.remove('hidden');
                if (loadingProgress) loadingProgress.textContent = '0%';
                
                try {
                    // åˆ›å»ºä¸´æ—¶canvasæ¥åˆ†æå›¾ç‰‡
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
                    
                    // è®¾ç½®ä¸´æ—¶canvaså°ºå¯¸
                    const maxSize = 800; // æœ€å¤§åˆ†æå°ºå¯¸ï¼Œæé«˜æ€§èƒ½
                    let scale = 1;
                    
                    if (config.imageOriginalWidth > maxSize || config.imageOriginalHeight > maxSize) {
                        scale = maxSize / Math.max(config.imageOriginalWidth, config.imageOriginalHeight);
                    }
                    
                    const analysisWidth = Math.floor(config.imageOriginalWidth * scale);
                    const analysisHeight = Math.floor(config.imageOriginalHeight * scale);
                    
                    console.log(`åˆ†æå°ºå¯¸: ${analysisWidth}x${analysisHeight} (ç¼©æ”¾æ¯”ä¾‹: ${scale.toFixed(2)})`);
                    
                    tempCanvas.width = analysisWidth;
                    tempCanvas.height = analysisHeight;
                    
                    // æ¸…é™¤canvas
                    tempCtx.clearRect(0, 0, analysisWidth, analysisHeight);
                    
                    // ç»˜åˆ¶å›¾ç‰‡
                    tempCtx.drawImage(shipImage, 0, 0, analysisWidth, analysisHeight);
                    
                    console.log('å›¾ç‰‡ç»˜åˆ¶æˆåŠŸ');
                    
                    // è·å–åƒç´ æ•°æ®
                    const imageData = tempCtx.getImageData(0, 0, analysisWidth, analysisHeight);
                    const data = imageData.data;
                    const totalPixels = analysisWidth * analysisHeight;
                    
                    console.log(`å¼€å§‹åˆ†æ ${totalPixels} ä¸ªåƒç´ ...`);
                    
                    // åˆå§‹åŒ–è¾¹ç•Œå€¼
                    let minX = analysisWidth;
                    let minY = analysisHeight;
                    let maxX = 0;
                    let maxY = 0;
                    let opaquePixels = 0;
                    
                    // ä½¿ç”¨æ›´é«˜æ•ˆçš„åˆ†ææ–¹æ³• - æ”¹è¿›ç‰ˆæœ¬
                    const batchSize = 50000; // æ¯æ‰¹å¤„ç†çš„åƒç´ æ•°
                    const batchCount = Math.ceil(totalPixels / batchSize);
                    
                    // åˆ›å»ºé€æ˜åº¦é˜ˆå€¼æ•°ç»„ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­
                    const alphaThreshold = config.detectionSensitivity;
                    
                    for (let batch = 0; batch < batchCount; batch++) {
                        const startPixel = batch * batchSize;
                        const endPixel = Math.min(startPixel + batchSize, totalPixels);
                        
                        for (let pixel = startPixel; pixel < endPixel; pixel++) {
                            const pixelIndex = pixel * 4;
                            const alpha = data[pixelIndex + 3];
                            
                            // æ£€æµ‹ä¸é€æ˜åƒç´ ï¼ˆä½¿ç”¨å¯é…ç½®çš„é˜ˆå€¼ï¼‰
                            if (alpha > alphaThreshold) {
                                opaquePixels++;
                                
                                const x = pixel % analysisWidth;
                                const y = Math.floor(pixel / analysisWidth);
                                
                                if (x < minX) minX = x;
                                if (x > maxX) maxX = x;
                                if (y < minY) minY = y;
                                if (y > maxY) maxY = y;
                            }
                        }
                        
                        // æ›´æ–°è¿›åº¦
                        const percent = Math.round(((batch + 1) / batchCount) * 100);
                        if (loadingProgress) loadingProgress.textContent = percent + '%';
                        
                        // æ¯å¤„ç†ä¸€æ‰¹è®©UIæ›´æ–°ä¸€æ¬¡
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                    
                    // å¦‚æœå¯ç”¨äº†è¾¹ç¼˜æ£€æµ‹ï¼Œè¿›è¡Œç¬¬äºŒè½®æ‰«æä»¥å»é™¤è¾¹ç¼˜é€æ˜åƒç´ 
                    if (config.detectEdgePixels && minX < maxX && minY < maxY) {
                        console.log('å¼€å§‹è¾¹ç¼˜æ£€æµ‹...');
                        
                        // åˆ›å»ºä¸€ä¸ªäºŒç»´æ•°ç»„æ¥æ ‡è®°æœ‰æ•ˆåƒç´ 
                        const width = analysisWidth;
                        const height = analysisHeight;
                        const visited = new Array(width * height).fill(false);
                        const valid = new Array(width * height).fill(false);
                        
                        // åˆå§‹ç§å­ï¼šæ‰€æœ‰ä¸é€æ˜åƒç´ 
                        for (let i = 0; i < totalPixels; i++) {
                            const pixelIndex = i * 4;
                            if (data[pixelIndex + 3] > alphaThreshold) {
                                valid[i] = true;
                            }
                        }
                        
                        // æ´ªæ°´å¡«å……ç®—æ³•å»é™¤å­¤ç«‹åŒºåŸŸ
                        const queue = [];
                        
                        // ä»è¾¹ç•Œå¼€å§‹å¡«å……
                        for (let x = 0; x < width; x++) {
                            for (let y of [0, height - 1]) {
                                const index = y * width + x;
                                if (valid[index] && !visited[index]) {
                                    queue.push({x, y});
                                    visited[index] = true;
                                    valid[index] = false; // è¾¹ç¼˜æ ‡è®°ä¸ºæ— æ•ˆ
                                }
                            }
                        }
                        
                        for (let y = 0; y < height; y++) {
                            for (let x of [0, width - 1]) {
                                const index = y * width + x;
                                if (valid[index] && !visited[index]) {
                                    queue.push({x, y});
                                    visited[index] = true;
                                    valid[index] = false; // è¾¹ç¼˜æ ‡è®°ä¸ºæ— æ•ˆ
                                }
                            }
                        }
                        
                        // BFSæ´ªæ°´å¡«å……
                        while (queue.length > 0) {
                            const {x, y} = queue.shift();
                            
                            // æ£€æŸ¥å››ä¸ªæ–¹å‘
                            const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];
                            for (const [dx, dy] of directions) {
                                const nx = x + dx;
                                const ny = y + dy;
                                
                                if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                    const nIndex = ny * width + nx;
                                    if (valid[nIndex] && !visited[nIndex]) {
                                        visited[nIndex] = true;
                                        valid[nIndex] = false; // è¿æ¥è¾¹ç¼˜çš„æ ‡è®°ä¸ºæ— æ•ˆ
                                        queue.push({x: nx, y: ny});
                                    }
                                }
                            }
                        }
                        
                        // é‡æ–°è®¡ç®—è¾¹ç•Œå’Œè®¡æ•°
                        minX = width;
                        minY = height;
                        maxX = 0;
                        maxY = 0;
                        opaquePixels = 0;
                        
                        for (let i = 0; i < totalPixels; i++) {
                            if (valid[i]) {
                                opaquePixels++;
                                
                                const x = i % width;
                                const y = Math.floor(i / width);
                                
                                if (x < minX) minX = x;
                                if (x > maxX) maxX = x;
                                if (y < minY) minY = y;
                                if (y > maxY) maxY = y;
                            }
                        }
                        
                        console.log('è¾¹ç¼˜æ£€æµ‹å®Œæˆï¼Œå‰©ä½™ä¸é€æ˜åƒç´ :', opaquePixels);
                    }
                    
                    // åˆ†æå®Œæˆ
                    console.log('åˆ†æå®Œæˆ');
                    console.log(`æ‰¾åˆ° ${opaquePixels} ä¸ªä¸é€æ˜åƒç´ `);
                    console.log(`å†…å®¹è¾¹ç•Œ: x[${minX}, ${maxX}], y[${minY}, ${maxY}]`);
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸é€æ˜åƒç´ ï¼Œä½¿ç”¨æ•´ä¸ªå›¾ç‰‡
                    if (minX > maxX || minY > maxY || opaquePixels === 0) {
                        console.log('æœªæ£€æµ‹åˆ°ä¸é€æ˜å†…å®¹ï¼Œä½¿ç”¨æ•´ä¸ªå›¾ç‰‡');
                        minX = 0;
                        minY = 0;
                        maxX = analysisWidth - 1;
                        maxY = analysisHeight - 1;
                        opaquePixels = totalPixels;
                    }
                    
                    // è®¡ç®—å†…å®¹è¾¹ç•Œï¼ˆç¼©æ”¾åˆ°åŸå§‹å°ºå¯¸ï¼‰
                    const contentWidth = (maxX - minX + 1) / scale;
                    const contentHeight = (maxY - minY + 1) / scale;
                    const contentMinX = minX / scale;
                    const contentMinY = minY / scale;
                    const contentMaxX = maxX / scale;
                    const contentMaxY = maxY / scale;
                    
                    // è®¡ç®—å†…å®¹ä¸­å¿ƒ
                    const contentCenterX = contentMinX + contentWidth / 2;
                    const contentCenterY = contentMinY + contentHeight / 2;
                    const fileCenterX = config.imageOriginalWidth / 2;
                    const fileCenterY = config.imageOriginalHeight / 2;
                    
                    // è®¡ç®—ä¸­å¿ƒåç§»
                    const centerOffsetX = contentCenterX - fileCenterX;
                    const centerOffsetY = contentCenterY - fileCenterY;
                    
                    // ä¿å­˜è¾¹ç•Œä¿¡æ¯
                    config.contentBounds = {
                        width: contentWidth,
                        height: contentHeight,
                        minX: contentMinX,
                        minY: contentMinY,
                        maxX: contentMaxX,
                        maxY: contentMaxY,
                        centerX: contentCenterX,
                        centerY: contentCenterY,
                        centerOffsetX: centerOffsetX,
                        centerOffsetY: centerOffsetY
                    };
                    
                    config.fileBounds = {
                        width: config.imageOriginalWidth,
                        height: config.imageOriginalHeight
                    };
                    
                    // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
                    updateDimensionInfo();
                    
                    // å¦‚æœå½“å‰æ˜¯å†…å®¹æ˜ å°„æ¨¡å¼ï¼Œæ›´æ–°å°ºå¯¸
                    if (config.mappingMode === 'content') {
                        updateImageSizeFromMode();
                        calculateImageDisplaySize();
                        updateImagePosition();
                    }
                    
                    // è®¡ç®—é€æ˜åŒºåŸŸæ¯”ä¾‹
                    const fileArea = config.imageOriginalWidth * config.imageOriginalHeight;
                    const contentArea = config.contentBounds.width * config.contentBounds.height;
                    const transparencyPercent = ((1 - opaquePixels / totalPixels) * 100).toFixed(1);
                    const transparencyAreaPercent = ((fileArea - contentArea) / fileArea * 100).toFixed(1);
                    
                    // å¦‚æœå¼€å¯äº†è‡ªåŠ¨å±…ä¸­ï¼Œæ‰§è¡Œå±…ä¸­æ“ä½œ
                    if (config.autoCenterContent && config.mappingMode === 'content') {
                        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIæ›´æ–°å®Œæˆ
                        setTimeout(() => {
                            centerContentToOrigin();
                        }, 100);
                    }
                    
                    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                    const message = `âœ… å†…å®¹è¾¹ç•Œæ£€æµ‹å®Œæˆï¼\n` +
                                   `æ–‡ä»¶å°ºå¯¸: ${config.imageOriginalWidth}Ã—${config.imageOriginalHeight}åƒç´ \n` +
                                   `å†…å®¹å°ºå¯¸: ${Math.round(contentWidth)}Ã—${Math.round(contentHeight)}åƒç´ \n` +
                                   `å†…å®¹ä¸­å¿ƒåç§»: (${Math.round(centerOffsetX)}, ${Math.round(centerOffsetY)})åƒç´ \n` +
                                   `åƒç´ é€æ˜åº¦: ${transparencyPercent}%\n` +
                                   `åŒºåŸŸé€æ˜åº¦: ${transparencyAreaPercent}%\n\n` +
                                   `å»ºè®®ä½¿ç”¨"ä»…æ˜ å°„å†…å®¹åŒºåŸŸ"æ¨¡å¼è·å¾—æ›´ç²¾ç¡®çš„åæ ‡æ˜ å°„ã€‚\n` +
                                   `ç‚¹å‡»"ä¸­å¿ƒå¯¹é½åˆ°åŸç‚¹"æŒ‰é’®å°†å†…å®¹ä¸­å¿ƒå¯¹é½åˆ°åæ ‡ç³»åŸç‚¹ã€‚`;
                    
                    // è®¾ç½®æœ€ç»ˆè¿›åº¦ä¸º100%
                    if (loadingProgress) loadingProgress.textContent = '100%';
                    
                    // å»¶è¿Ÿ500msè®©ç”¨æˆ·çœ‹åˆ°100%è¿›åº¦ï¼Œç„¶åéšè—é®ç½©å¹¶æ˜¾ç¤ºç»“æœ
                    setTimeout(() => {
                        // éšè—åŠ è½½é®ç½©
                        if (loadingOverlay) loadingOverlay.classList.add('hidden');
                        
                        alert(message);
                        console.log(message);
                    }, 500);
                    
                } catch (error) {
                    console.error('åˆ†æå›¾ç‰‡å†…å®¹æ—¶å‡ºé”™:', error);
                    
                    // éšè—åŠ è½½é®ç½©
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                    if (loadingProgress) loadingProgress.textContent = '0%';
                    
                    alert('åˆ†æå›¾ç‰‡å†…å®¹æ—¶å‡ºé”™: ' + error.message);
                }
            }

            // æ›´æ–°å°ºå¯¸ä¿¡æ¯æ˜¾ç¤º
            function updateDimensionInfo() {
                if (!config.hasImage) return;
                
                // æ–‡ä»¶å°ºå¯¸æ€»æ˜¯å¯ä»¥æ˜¾ç¤º
                if (fileDimensions) {
                    fileDimensions.textContent = `${config.imageOriginalWidth}Ã—${config.imageOriginalHeight}`;
                }
                
                // å†…å®¹å°ºå¯¸
                if (contentDimensions && transparencyRatio && contentOffset) {
                    if (config.contentBounds) {
                        contentDimensions.textContent = `${Math.round(config.contentBounds.width)}Ã—${Math.round(config.contentBounds.height)}`;
                        
                        // è®¡ç®—é€æ˜åŒºåŸŸæ¯”ä¾‹
                        const fileArea = config.imageOriginalWidth * config.imageOriginalHeight;
                        const contentArea = config.contentBounds.width * config.contentBounds.height;
                        const transparency = ((fileArea - contentArea) / fileArea * 100).toFixed(1);
                        transparencyRatio.textContent = transparency;
                        
                        // æ˜¾ç¤ºä¸­å¿ƒåç§»
                        contentOffset.textContent = `(${Math.round(config.contentBounds.centerOffsetX)}, ${Math.round(config.contentBounds.centerOffsetY)})`;
                    } else {
                        contentDimensions.textContent = 'æœªæ£€æµ‹';
                        transparencyRatio.textContent = 'æœªçŸ¥';
                        contentOffset.textContent = '(0, 0)';
                    }
                }
            }

            // æ ¹æ®æ˜ å°„æ¨¡å¼æ›´æ–°å›¾ç‰‡å°ºå¯¸
            function updateImageSizeFromMode() {
                if (!config.hasImage) return;
                
                if (config.mappingMode === 'content' && config.contentBounds) {
                    // ä½¿ç”¨å†…å®¹åŒºåŸŸå°ºå¯¸
                    const contentAspectRatio = config.contentBounds.width / config.contentBounds.height;
                    const shipLength = parseFloat(document.getElementById('shipLength').value);
                    const shipWidth = parseFloat(document.getElementById('shipWidth').value);
                    
                    if (contentAspectRatio > 1) {
                        // å†…å®¹å®½åº¦ > é«˜åº¦ï¼Œä»¥é•¿åº¦ä¸ºå‡†
                        config.imageLength = shipLength;
                        config.imageWidth = shipLength / contentAspectRatio;
                    } else {
                        // å†…å®¹é«˜åº¦ >= å®½åº¦ï¼Œä»¥å®½åº¦ä¸ºå‡†
                        config.imageWidth = shipWidth;
                        config.imageLength = shipWidth * contentAspectRatio;
                    }
                } else {
                    // ä½¿ç”¨æ•´ä¸ªæ–‡ä»¶å°ºå¯¸
                    const fileAspectRatio = config.imageOriginalWidth / config.imageOriginalHeight;
                    const shipLength = parseFloat(document.getElementById('shipLength').value);
                    const shipWidth = parseFloat(document.getElementById('shipWidth').value);
                    
                    if (fileAspectRatio > 1) {
                        // æ–‡ä»¶å®½åº¦ > é«˜åº¦ï¼Œä»¥é•¿åº¦ä¸ºå‡†
                        config.imageLength = shipLength;
                        config.imageWidth = shipLength / fileAspectRatio;
                    } else {
                        // æ–‡ä»¶é«˜åº¦ >= å®½åº¦ï¼Œä»¥å®½åº¦ä¸ºå‡†
                        config.imageWidth = shipWidth;
                        config.imageLength = shipWidth * fileAspectRatio;
                    }
                }
                
                // æ›´æ–°UI
                const imageLengthInput = document.getElementById('imageLength');
                const imageWidthInput = document.getElementById('imageWidth');
                if (imageLengthInput) imageLengthInput.value = config.imageLength.toFixed(1);
                if (imageWidthInput) imageWidthInput.value = config.imageWidth.toFixed(1);
            }

            // è°ƒæ•´Canvaså¤§å°ä»¥é€‚åº”çª—å£
            function resizeCanvas() {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                drawCoordinateSystem();
                updateImagePosition();
            }

            // ç»˜åˆ¶åæ ‡ç³»
            function drawCoordinateSystem() {
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const centerX = canvas.width / 2 + config.offsetX;
                const centerY = canvas.height / 2 + config.offsetY;
                
                // ç»˜åˆ¶ç½‘æ ¼
                ctx.strokeStyle = 'rgba(100, 100, 100, 0.2)';
                ctx.lineWidth = 1;
                
                // å‚ç›´çº¿
                for (let x = centerX % (config.scale * config.gridSize); x < canvas.width; x += config.scale * config.gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                // æ°´å¹³çº¿
                for (let y = centerY % (config.scale * config.gridSize); y < canvas.height; y += config.scale * config.gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶åæ ‡è½´
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                
                // Xè½´
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(canvas.width, centerY);
                ctx.stroke();
                
                // Yè½´
                ctx.beginPath();
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, canvas.height);
                ctx.stroke();
                
                // ç»˜åˆ¶ç®­å¤´
                // Xè½´ç®­å¤´
                ctx.beginPath();
                ctx.moveTo(canvas.width - 10, centerY - 5);
                ctx.lineTo(canvas.width, centerY);
                ctx.lineTo(canvas.width - 10, centerY + 5);
                ctx.stroke();
                
                // Yè½´ç®­å¤´
                ctx.beginPath();
                ctx.moveTo(centerX - 5, 10);
                ctx.lineTo(centerX, 0);
                ctx.lineTo(centerX + 5, 10);
                ctx.stroke();
                
                // ç»˜åˆ¶åˆ»åº¦
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Xè½´åˆ»åº¦
                for (let x = centerX % config.scale; x < canvas.width; x += config.scale) {
                    const value = Math.round((x - centerX) / config.scale);
                    if (value !== 0) {
                        ctx.beginPath();
                        ctx.moveTo(x, centerY - 5);
                        ctx.lineTo(x, centerY + 5);
                        ctx.stroke();
                        
                        ctx.fillText(value.toString(), x, centerY + 15);
                    }
                }
                
                // Yè½´åˆ»åº¦
                for (let y = centerY % config.scale; y < canvas.height; y += config.scale) {
                    const value = Math.round((centerY - y) / config.scale);
                    if (value !== 0) {
                        ctx.beginPath();
                        ctx.moveTo(centerX - 5, y);
                        ctx.lineTo(centerX + 5, y);
                        ctx.stroke();
                        
                        ctx.fillText(value.toString(), centerX - 15, y);
                    }
                }
                
                // ç»˜åˆ¶åŸç‚¹
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText('O', centerX - 10, centerY + 15);
                
                // ç»˜åˆ¶å†…å®¹è¾¹ç•Œæ¡†ï¼ˆå¦‚æœå¼€å¯äº†æ˜¾ç¤ºï¼‰
                if (config.hasImage && config.contentBounds && config.showContentBounds) {
                    drawContentBounds();
                }
                
                // ç»˜åˆ¶æ‰€æœ‰æ¨¡å—ï¼ˆæ­¦å™¨è£…å¤‡ç‚¹ä½ï¼‰
                drawModules();
            }

            // ç»˜åˆ¶å†…å®¹è¾¹ç•Œæ¡†
            function drawContentBounds() {
                if (!config.contentBounds) return;
                
                const centerX = canvas.width / 2 + config.offsetX;
                const centerY = canvas.height / 2 + config.offsetY;
                
                // è®¡ç®—è¾¹ç•Œæ¡†åœ¨Canvasä¸Šçš„ä½ç½®
                const boundsWidth = config.contentBounds.width * config.imageScale;
                const boundsHeight = config.contentBounds.height * config.imageScale;
                
                // è®¡ç®—è¾¹ç•Œæ¡†å·¦ä¸Šè§’ä½ç½®
                const boundsX = centerX - boundsWidth / 2 + config.imageOffsetX;
                const boundsY = centerY - boundsHeight / 2 + config.imageOffsetY;
                
                // ç»˜åˆ¶çº¢è‰²è¾¹ç•Œæ¡†
                ctx.strokeStyle = '#ff4757';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                
                ctx.beginPath();
                ctx.rect(boundsX, boundsY, boundsWidth, boundsHeight);
                ctx.stroke();
                
                // é‡ç½®çº¿æ¡æ ·å¼
                ctx.setLineDash([]);
                
                // ç»˜åˆ¶ä¸­å¿ƒç‚¹
                ctx.fillStyle = '#ff4757';
                ctx.beginPath();
                ctx.arc(boundsX + boundsWidth / 2, boundsY + boundsHeight / 2, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶æ ‡ç­¾
                ctx.fillStyle = '#ff4757';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText('å†…å®¹è¾¹ç•Œ', boundsX, boundsY - 15);
            }

            // ç»˜åˆ¶æ‰€æœ‰æ¨¡å—ï¼ˆæ­¦å™¨è£…å¤‡ç‚¹ä½ï¼‰
            function drawModules() {
                const centerX = canvas.width / 2 + config.offsetX;
                const centerY = canvas.height / 2 + config.offsetY;
                
                config.modules.forEach((module, index) => {
                    const x = centerX + module.forward * config.scale;
                    const y = centerY - module.side * config.scale;
                    
                    // è®¾ç½®é¢œè‰²å’Œæ ‡ç­¾
                    let color, label;
                    if (module.type === 'armament') {
                        color = module === config.selectedModule ? '#ffa502' : '#ff4757';
                        label = `${module.name}: (${module.forward.toFixed(1)}, ${module.side.toFixed(1)})`;
                    } else if (module.type === 'turret') {
                        color = module === config.selectedModule ? '#7bed9f' : '#2ed573';
                        label = `${module.name}: (${module.forward.toFixed(1)}, ${module.side.toFixed(1)})`;
                    }
                    
                    // ç»˜åˆ¶æ¨¡å—ç‚¹
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶æ¨¡å—æ ‡ç­¾
                    ctx.fillStyle = color;
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    
                    ctx.fillText(label, x + 8, y - 8);
                    
                    // å¦‚æœæ˜¯å¯¹ç§°æ¨¡å—ï¼Œç»˜åˆ¶å¯¹ç§°ç‚¹
                    if (module.symmetrical && module.side !== 0) {
                        const symY = centerY + module.side * config.scale;
                        
                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(x, symY, 6, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillText(label + ' (å¯¹ç§°)', x + 8, symY - 8);
                    }
                });
            }

            // å°†å±å¹•åæ ‡è½¬æ¢ä¸ºæ•°å­¦åæ ‡
            function screenToMath(x, y) {
                const centerX = canvas.width / 2 + config.offsetX;
                const centerY = canvas.height / 2 + config.offsetY;
                
                return {
                    forward: (x - centerX) / config.scale,
                    side: (centerY - y) / config.scale
                };
            }

            // æ›´æ–°ä¿¡æ¯é¢æ¿
            function updateInfoPanel(x, y) {
                const mathCoords = screenToMath(x, y);
                const scaleFactor = (config.scale / 50).toFixed(2);
                
                let info = `ç¼©æ”¾: ${scaleFactor}x | åæ ‡: (${mathCoords.forward.toFixed(2)}, ${mathCoords.side.toFixed(2)})`;
                
                if (config.hasImage) {
                    info += ` | å›¾ç‰‡å°ºå¯¸: ${config.imageLength.toFixed(1)}Ã—${config.imageWidth.toFixed(1)}ç±³`;
                    if (config.imageLocked) {
                        info += ' | å›¾ç‰‡å·²é”å®š';
                    }
                    if (config.mappingMode === 'content' && config.contentBounds) {
                        info += ' | å†…å®¹æ˜ å°„';
                        if (config.contentBounds.centerOffsetX !== 0 || config.contentBounds.centerOffsetY !== 0) {
                            info += ` | åç§»: (${Math.round(config.contentBounds.centerOffsetX)}, ${Math.round(config.contentBounds.centerOffsetY)})`;
                        }
                    }
                }
                
                infoPanel.textContent = info;
            }

            // è®¡ç®—å›¾ç‰‡åº”è¯¥æ˜¾ç¤ºçš„å°ºå¯¸ï¼ˆåŸºäºåæ ‡ç³»ç¼©æ”¾ï¼‰
            function calculateImageDisplaySize() {
                if (!config.hasImage) return;
                
                // å¦‚æœè‡ªåŠ¨é€‚åº”æ¨¡å¼å…³é—­ï¼Œä¿æŒå½“å‰ç¼©æ”¾
                if (!config.autoFitImage) return;
                
                // ç¡®å®šä½¿ç”¨çš„å°ºå¯¸ï¼ˆæ ¹æ®æ˜ å°„æ¨¡å¼ï¼‰
                let targetWidth, targetHeight;
                
                if (config.mappingMode === 'content' && config.contentBounds) {
                    // ä½¿ç”¨å†…å®¹åŒºåŸŸå°ºå¯¸
                    targetWidth = config.imageLength * config.scale;
                    targetHeight = config.imageWidth * config.scale;
                } else {
                    // ä½¿ç”¨æ•´ä¸ªæ–‡ä»¶å°ºå¯¸
                    targetWidth = config.imageLength * config.scale;
                    targetHeight = config.imageWidth * config.scale;
                }
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆç›¸å¯¹äºåŸå§‹å›¾ç‰‡å°ºå¯¸ï¼‰
                const scaleX = targetWidth / config.imageOriginalWidth;
                const scaleY = targetHeight / config.imageOriginalHeight;
                
                // å¦‚æœé”å®šå®½é«˜æ¯”ï¼Œä½¿ç”¨ä¸€è‡´çš„ç¼©æ”¾æ¯”ä¾‹
                if (config.lockAspectRatio) {
                    // ä½¿ç”¨æœ€å°çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å›¾ç‰‡å®Œå…¨æ˜¾ç¤º
                    config.imageScale = Math.min(scaleX, scaleY);
                } else {
                    // ä¸é”å®šå®½é«˜æ¯”æ—¶ï¼Œåˆ†åˆ«è®¡ç®—Xå’ŒYçš„ç¼©æ”¾
                    config.imageScale = 1; // ä½¿ç”¨ç»Ÿä¸€çš„ç¼©æ”¾ï¼Œå®é™…æ˜¾ç¤ºæ—¶åˆ†åˆ«å¤„ç†
                }
                
                // æ›´æ–°å›¾ç‰‡æ§åˆ¶é¢æ¿ä¸­çš„æ•°å€¼
                const imageLengthInput = document.getElementById('imageLength');
                const imageWidthInput = document.getElementById('imageWidth');
                if (imageLengthInput) imageLengthInput.value = config.imageLength;
                if (imageWidthInput) imageWidthInput.value = config.imageWidth;
            }

            // æ›´æ–°å›¾ç‰‡ä½ç½®å’Œå¤§å°
            function updateImagePosition() {
                if (!config.hasImage) return;
                
                // è®¡ç®—å›¾ç‰‡æ˜¾ç¤ºå°ºå¯¸
                let displayWidth, displayHeight;
                
                if (config.autoFitImage) {
                    // è‡ªåŠ¨é€‚åº”æ¨¡å¼ï¼šåŸºäºåæ ‡ç³»ç¼©æ”¾è®¡ç®—å°ºå¯¸
                    if (config.lockAspectRatio) {
                        // é”å®šå®½é«˜æ¯”ï¼Œä½¿ç”¨ç»Ÿä¸€çš„ç¼©æ”¾æ¯”ä¾‹
                        displayWidth = config.imageOriginalWidth * config.imageScale;
                        displayHeight = config.imageOriginalHeight * config.imageScale;
                    } else {
                        // ä¸é”å®šå®½é«˜æ¯”ï¼Œåˆ†åˆ«è®¡ç®—
                        displayWidth = config.imageLength * config.scale;
                        displayHeight = config.imageWidth * config.scale;
                    }
                } else {
                    // æ‰‹åŠ¨æ¨¡å¼ï¼šä½¿ç”¨å½“å‰ç¼©æ”¾æ¯”ä¾‹
                    displayWidth = config.imageOriginalWidth * config.imageScale;
                    displayHeight = config.imageOriginalHeight * config.imageScale;
                }
                
                shipImage.style.width = displayWidth + 'px';
                shipImage.style.height = displayHeight + 'px';
                
                // è®¡ç®—å›¾ç‰‡ä½ç½®
                if (config.centerImage) {
                    // å›¾ç‰‡å±…ä¸­ï¼šä¸­å¿ƒä¸ºåŸç‚¹(0,0)
                    const centerX = canvas.width / 2 + config.offsetX;
                    const centerY = canvas.height / 2 + config.offsetY;
                    
                    shipImage.style.left = (centerX - displayWidth / 2 + config.imageOffsetX) + 'px';
                    shipImage.style.top = (centerY - displayHeight / 2 + config.imageOffsetY) + 'px';
                } else {
                    // å›¾ç‰‡ä¸å±…ä¸­ï¼Œä½¿ç”¨åç§»é‡
                    const centerX = canvas.width / 2 + config.offsetX;
                    const centerY = canvas.height / 2 + config.offsetY;
                    
                    shipImage.style.left = (centerX + config.imageOffsetX) + 'px';
                    shipImage.style.top = (centerY + config.imageOffsetY) + 'px';
                }
            }

            // å›¾ç‰‡å°ºå¯¸å˜åŒ–æ—¶æ›´æ–°
            function updateImageSize() {
                if (!config.hasImage) return;
                
                // è·å–è¾“å…¥å€¼
                const newLength = parseFloat(document.getElementById('imageLength').value);
                const newWidth = parseFloat(document.getElementById('imageWidth').value);
                
                // å¦‚æœé”å®šå®½é«˜æ¯”ï¼Œè°ƒæ•´å®½åº¦ä»¥ä¿æŒæ¯”ä¾‹
                if (config.lockAspectRatio && config.imageOriginalWidth > 0 && config.imageOriginalHeight > 0) {
                    const aspectRatio = config.imageOriginalWidth / config.imageOriginalHeight;
                    
                    if (document.activeElement.id === 'imageLength') {
                        // ä¿®æ”¹äº†é•¿åº¦ï¼Œè‡ªåŠ¨è®¡ç®—å®½åº¦
                        config.imageLength = newLength;
                        config.imageWidth = config.imageLength / aspectRatio;
                    } else if (document.activeElement.id === 'imageWidth') {
                        // ä¿®æ”¹äº†å®½åº¦ï¼Œè‡ªåŠ¨è®¡ç®—é•¿åº¦
                        config.imageWidth = newWidth;
                        config.imageLength = config.imageWidth * aspectRatio;
                    }
                } else {
                    // ä¸é”å®šå®½é«˜æ¯”ï¼Œç›´æ¥è®¾ç½®
                    config.imageLength = newLength;
                    config.imageWidth = newWidth;
                }
                
                // é‡æ–°è®¡ç®—å›¾ç‰‡æ˜¾ç¤ºå°ºå¯¸
                calculateImageDisplaySize();
                updateImagePosition();
            }

            // é‡ç½®å›¾ç‰‡ä½ç½®å’Œå¤§å°
            function resetImage() {
                if (!config.hasImage) return;
                
                // é‡ç½®å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹
                config.imageScale = 1.0;
                
                // é‡ç½®å›¾ç‰‡åç§»é‡ï¼Œç¡®ä¿å›¾ç‰‡å±…ä¸­
                config.imageOffsetX = 0;
                config.imageOffsetY = 0;
                
                // å¦‚æœå¼€å¯è‡ªåŠ¨é€‚åº”ï¼Œé‡æ–°è®¡ç®—å°ºå¯¸
                if (config.autoFitImage) {
                    calculateImageDisplaySize();
                }
                
                // æ›´æ–°å›¾ç‰‡ä½ç½®
                updateImagePosition();
                
                // ç¡®ä¿å›¾ç‰‡å±…ä¸­
                if (config.centerImage) {
                    // å¼ºåˆ¶é‡æ–°è®¡ç®—å±…ä¸­ä½ç½®
                    const centerX = canvas.width / 2 + config.offsetX;
                    const centerY = canvas.height / 2 + config.offsetY;
                    
                    const displayWidth = parseFloat(shipImage.style.width) || config.imageOriginalWidth * config.imageScale;
                    const displayHeight = parseFloat(shipImage.style.height) || config.imageOriginalHeight * config.imageScale;
                    
                    shipImage.style.left = (centerX - displayWidth / 2) + 'px';
                    shipImage.style.top = (centerY - displayHeight / 2) + 'px';
                }
                
                console.log('å›¾ç‰‡å·²é‡ç½®ï¼Œå±…ä¸­åˆ°åŸç‚¹');
            }

            // æ·»åŠ æ¨¡å—
            function addModule(forward, side) {
                let module;
                
                if (config.currentModuleType === 'armament') {
                    module = {
                        type: 'armament',
                        name: 'Tomahawk',
                        forward: forward,
                        side: side,
                        angle: -90,
                        count: 2,
                        symmetrical: false,
                        hidden: false,
                        external: false
                    };
                } else if (config.currentModuleType === 'turret') {
                    module = {
                        type: 'turret',
                        name: 'Mark7',
                        forward: forward,
                        side: side,
                        angle: 0,
                        speed: 'slow',
                        azimuth_b: 20
                    };
                }
                
                config.modules.push(module);
                updateModuleList();
                drawCoordinateSystem();
            }

            // æ›´æ–°æ¨¡å—åˆ—è¡¨
            function updateModuleList() {
                if (!moduleList) return;
                
                moduleList.innerHTML = '';
                
                if (config.modules.length === 0) {
                    moduleList.innerHTML = '<div class="module-item">æš‚æ— æ¨¡å—</div>';
                    return;
                }
                
                config.modules.forEach((module, index) => {
                    const item = document.createElement('div');
                    item.className = 'module-item';
                    
                    let text = `${module.type === 'armament' ? 'æ­¦å™¨' : 'ç‚®å¡”'} ${index + 1}: ${module.name} (${module.forward.toFixed(1)}, ${module.side.toFixed(1)})`;
                    if (module.symmetrical) text += ' [å¯¹ç§°]';
                    if (module.hidden) text += ' [éšè—]';
                    if (module.external) text += ' [å¤–éƒ¨]';
                    
                    item.textContent = text;
                    item.dataset.index = index;
                    
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.module-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        selectModule(index);
                    });
                    
                    moduleList.appendChild(item);
                });
            }

            // é€‰æ‹©æ¨¡å—
            function selectModule(index) {
                config.selectedModule = config.modules[index];
                drawCoordinateSystem();
                
                // æ˜¾ç¤ºç¼–è¾‘å™¨å¹¶å¡«å……æ•°æ®
                if (moduleEditor) moduleEditor.classList.remove('hidden');
                
                if (config.selectedModule.type === 'armament') {
                    if (editorTitle) editorTitle.textContent = 'ç¼–è¾‘æ­¦å™¨';
                    if (armamentEditor) armamentEditor.classList.remove('hidden');
                    if (turretEditor) turretEditor.classList.add('hidden');
                    
                    document.getElementById('weaponName').value = config.selectedModule.name;
                    document.getElementById('weaponForward').value = config.selectedModule.forward;
                    document.getElementById('weaponSide').value = config.selectedModule.side;
                    document.getElementById('weaponAngle').value = config.selectedModule.angle;
                    document.getElementById('weaponCount').value = config.selectedModule.count;
                    document.getElementById('weaponSymmetrical').checked = config.selectedModule.symmetrical;
                    document.getElementById('weaponHidden').checked = config.selectedModule.hidden;
                    document.getElementById('weaponExternal').checked = config.selectedModule.external;
                } else if (config.selectedModule.type === 'turret') {
                    if (editorTitle) editorTitle.textContent = 'ç¼–è¾‘ç‚®å¡”';
                    if (armamentEditor) armamentEditor.classList.add('hidden');
                    if (turretEditor) turretEditor.classList.remove('hidden');
                    
                    document.getElementById('turretName').value = config.selectedModule.name;
                    document.getElementById('turretForward').value = config.selectedModule.forward;
                    document.getElementById('turretSide').value = config.selectedModule.side;
                    document.getElementById('turretAngle').value = config.selectedModule.angle;
                    document.getElementById('turretSpeed').value = config.selectedModule.speed;
                    document.getElementById('turretAzimuthB').value = config.selectedModule.azimuth_b;
                }
            }

            // æ›´æ–°æ¨¡å—
            function updateModule() {
                if (!config.selectedModule) return;
                
                if (config.selectedModule.type === 'armament') {
                    config.selectedModule.name = document.getElementById('weaponName').value;
                    config.selectedModule.forward = parseFloat(document.getElementById('weaponForward').value);
                    config.selectedModule.side = parseFloat(document.getElementById('weaponSide').value);
                    config.selectedModule.angle = parseFloat(document.getElementById('weaponAngle').value);
                    config.selectedModule.count = parseInt(document.getElementById('weaponCount').value);
                    config.selectedModule.symmetrical = document.getElementById('weaponSymmetrical').checked;
                    config.selectedModule.hidden = document.getElementById('weaponHidden').checked;
                    config.selectedModule.external = document.getElementById('weaponExternal').checked;
                } else if (config.selectedModule.type === 'turret') {
                    config.selectedModule.name = document.getElementById('turretName').value;
                    config.selectedModule.forward = parseFloat(document.getElementById('turretForward').value);
                    config.selectedModule.side = parseFloat(document.getElementById('turretSide').value);
                    config.selectedModule.angle = parseFloat(document.getElementById('turretAngle').value);
                    config.selectedModule.speed = document.getElementById('turretSpeed').value;
                    config.selectedModule.azimuth_b = parseInt(document.getElementById('turretAzimuthB').value);
                }
                
                updateModuleList();
                drawCoordinateSystem();
            }

            // åˆ é™¤æ¨¡å—
            function deleteModule() {
                if (!config.selectedModule) return;
                
                const index = config.modules.indexOf(config.selectedModule);
                if (index !== -1) {
                    config.modules.splice(index, 1);
                    config.selectedModule = null;
                    if (moduleEditor) moduleEditor.classList.add('hidden');
                    updateModuleList();
                    drawCoordinateSystem();
                }
            }

            // ç”Ÿæˆèˆ¹åªä»£ç 
            function generateShipCode() {
                const shipName = document.getElementById('shipName').value;
                const shipClass = shipClassSelect.value === 'custom' ? shipClassCustom.value : shipClassSelect.value;
                const shipLevel = document.getElementById('shipLevel').value;
                const shipLength = document.getElementById('shipLength').value;
                const shipWidth = document.getElementById('shipWidth').value;
                const shipDraft = document.getElementById('shipDraft').value;
                
                if (shipClassSelect.value === 'custom' && !shipClassCustom.value.trim()) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰èˆ¹åªç±»å‹');
                    return;
                }
                
                let code = `#[info(\n        label = "${shipName}",\n        link = "https://en.wikipedia.org/wiki/${shipName}-class_${shipClass.toLowerCase()}"\n    )]\n`;
                code += `    #[entity(Boat, ${shipClass}, level = ${shipLevel})]\n`;
                code += `    #[size(length = ${shipLength}, width = ${shipWidth}, draft = ${shipDraft})]\n`;
                code += `    #[props(speed = 16.977)]\n`;
                code += `    #[sensors(radar, visual)]\n`;
                
                // æ·»åŠ æ­¦å™¨æ¨¡å—
                config.modules.filter(m => m.type === 'armament').forEach(module => {
                    code += `    #[armament(${module.name}, forward = ${module.forward}, side = ${module.side}, angle = ${module.angle}, count = ${module.count}`;
                    if (module.symmetrical) code += ', symmetrical';
                    if (module.hidden) code += ', hidden';
                    if (module.external) code += ', external';
                    code += ')]\n';
                });
                
                // æ·»åŠ ç‚®å¡”æ¨¡å—
                config.modules.filter(m => m.type === 'turret').forEach(module => {
                    code += `    #[turret(${module.name}, forward = ${module.forward}, side = ${module.side}, ${module.speed}, azimuth_b = ${module.azimuth_b})]\n`;
                });
                
                code += `    ${shipName},`;
                
                codeOutput.textContent = code;
            }

            // äº‹ä»¶ç›‘å¬å™¨
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                config.isDragging = true;
                config.lastX = e.clientX;
                config.lastY = e.clientY;
            });

            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                updateInfoPanel(x, y);
                
                if (config.isDragging) {
                    const dx = e.clientX - config.lastX;
                    const dy = e.clientY - config.lastY;
                    
                    config.offsetX += dx;
                    config.offsetY += dy;
                    
                    config.lastX = e.clientX;
                    config.lastY = e.clientY;
                    
                    drawCoordinateSystem();
                    updateImagePosition();
                }
            });

            canvas.addEventListener('mouseup', () => {
                config.isDragging = false;
            });

            canvas.addEventListener('mouseleave', () => {
                config.isDragging = false;
            });

            // å›¾ç‰‡æ‹–æ‹½äº‹ä»¶ - ç°åœ¨é€šè¿‡å›¾ç‰‡æœ¬èº«çš„é¼ æ ‡äº‹ä»¶å¤„ç†
            shipImage.addEventListener('mousedown', (e) => {
                if (config.imageLocked) return; // å¦‚æœå›¾ç‰‡è¢«é”å®šï¼Œä¸å¤„ç†æ‹–æ‹½
                
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°canvas
                
                config.isImageDragging = true;
                config.lastImageX = e.clientX;
                config.lastImageY = e.clientY;
                
                // é˜²æ­¢å›¾ç‰‡è¢«æ‹–æ‹½ï¼ˆåœ¨æŸäº›æµè§ˆå™¨ä¸­ï¼‰
                e.preventDefault();
            });

            shipImage.addEventListener('mousemove', (e) => {
                if (config.imageLocked || !config.isImageDragging) return;
                
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°canvas
                
                const dx = e.clientX - config.lastImageX;
                const dy = e.clientY - config.lastImageY;
                
                config.imageOffsetX += dx;
                config.imageOffsetY += dy;
                
                config.lastImageX = e.clientX;
                config.lastImageY = e.clientY;
                
                updateImagePosition();
            });

            shipImage.addEventListener('mouseup', () => {
                config.isImageDragging = false;
            });

            shipImage.addEventListener('mouseleave', () => {
                config.isImageDragging = false;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                const mathCoords = screenToMath(e.clientX, e.clientY);
                
                if (e.deltaY < 0) {
                    // æ”¾å¤§
                    config.scale *= 1.1;
                } else {
                    // ç¼©å°
                    config.scale /= 1.1;
                }
                
                // é™åˆ¶ç¼©æ”¾èŒƒå›´
                config.scale = Math.max(10, Math.min(500, config.scale));
                
                // è°ƒæ•´åç§»ä»¥ä¿æŒé¼ æ ‡ä½ç½®å¯¹åº”çš„æ•°å­¦åæ ‡ä¸å˜
                const newMathCoords = screenToMath(e.clientX, e.clientY);
                config.offsetX += (newMathCoords.forward - mathCoords.forward) * config.scale;
                config.offsetY -= (newMathCoords.side - mathCoords.side) * config.scale;
                
                // é‡æ–°è®¡ç®—å›¾ç‰‡å°ºå¯¸ï¼ˆå¦‚æœå¼€å¯äº†è‡ªåŠ¨é€‚åº”ï¼‰
                if (config.hasImage && config.autoFitImage) {
                    calculateImageDisplaySize();
                }
                
                drawCoordinateSystem();
                updateImagePosition();
            });

            canvas.addEventListener('dblclick', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const mathCoords = screenToMath(x, y);
                
                // æ·»åŠ å½“å‰ç±»å‹çš„æ¨¡å—
                addModule(mathCoords.forward, mathCoords.side);
            });

            // æ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('zoomIn').addEventListener('click', () => {
                config.scale *= 1.2;
                config.scale = Math.min(500, config.scale);
                
                if (config.hasImage && config.autoFitImage) {
                    calculateImageDisplaySize();
                }
                
                drawCoordinateSystem();
                updateImagePosition();
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                config.scale /= 1.2;
                config.scale = Math.max(10, config.scale);
                
                if (config.hasImage && config.autoFitImage) {
                    calculateImageDisplaySize();
                }
                
                drawCoordinateSystem();
                updateImagePosition();
            });

            document.getElementById('resetView').addEventListener('click', () => {
                config.scale = 50;
                config.offsetX = 0;
                config.offsetY = 0;
                
                if (config.hasImage && config.autoFitImage) {
                    calculateImageDisplaySize();
                }
                
                drawCoordinateSystem();
                updateImagePosition();
            });

            document.getElementById('importImageBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            // ä½¿ç”¨Blob URLé¿å…è·¨åŸŸé—®é¢˜
                            const blob = new Blob([event.target.result], { type: file.type });
                            const blobUrl = URL.createObjectURL(blob);
                            
                            shipImage.src = blobUrl;
                            shipImage.style.display = 'block';
                            config.hasImage = true;
                            
                            // æ˜¾ç¤ºå›¾ç‰‡æ§åˆ¶é¢æ¿
                            if (imageControlPanel) imageControlPanel.style.display = 'block';
                            
                            shipImage.onload = () => {
                                // ä¿å­˜åŸå§‹å›¾ç‰‡å°ºå¯¸
                                config.imageOriginalWidth = shipImage.naturalWidth;
                                config.imageOriginalHeight = shipImage.naturalHeight;
                                
                                // é»˜è®¤ä½¿ç”¨èˆ¹åªå°ºå¯¸ä½œä¸ºå›¾ç‰‡ä»£è¡¨çš„å°ºå¯¸
                                config.imageLength = parseFloat(document.getElementById('shipLength').value);
                                config.imageWidth = parseFloat(document.getElementById('shipWidth').value);
                                
                                // åˆå§‹åŒ–å›¾ç‰‡æ§åˆ¶é¢æ¿
                                document.getElementById('imageLength').value = config.imageLength;
                                document.getElementById('imageWidth').value = config.imageWidth;
                                document.getElementById('lockAspectRatio').checked = config.lockAspectRatio;
                                document.getElementById('autoFitImage').checked = config.autoFitImage;
                                document.getElementById('centerImage').checked = config.centerImage;
                                
                                // è®¾ç½®é»˜è®¤æ˜ å°„æ¨¡å¼
                                document.getElementById('mapWholeImage').checked = true;
                                config.mappingMode = 'whole';
                                
                                // åˆå§‹åŒ–æ£€æµ‹è®¾ç½®
                                if (sensitivitySlider) sensitivitySlider.value = config.detectionSensitivity;
                                if (sensitivityValue) sensitivityValue.textContent = config.detectionSensitivity;
                                if (detectEdges) detectEdges.checked = config.detectEdgePixels;
                                if (autoCenterContent) autoCenterContent.checked = config.autoCenterContent;
                                
                                // é‡ç½®å†…å®¹è¾¹ç•Œä¿¡æ¯
                                config.contentBounds = null;
                                config.fileBounds = null;
                                config.showContentBounds = false;
                                if (showContentBoundsBtn) showContentBoundsBtn.textContent = 'æ˜¾ç¤ºå†…å®¹è¾¹ç•Œ';
                                
                                // é‡ç½®å›¾ç‰‡ä½ç½®å’Œç¼©æ”¾
                                resetImage();
                                
                                // é»˜è®¤é”å®šå›¾ç‰‡ï¼Œé˜²æ­¢è¯¯æ“ä½œ
                                config.imageLocked = true;
                                if (lockImageBtn) {
                                    lockImageBtn.innerHTML = 'ğŸ”’ é”å®šå›¾ç‰‡';
                                    lockImageBtn.classList.add('locked');
                                }
                                shipImage.style.pointerEvents = 'none';
                                
                                // æ›´æ–°å°ºå¯¸ä¿¡æ¯
                                updateDimensionInfo();
                                
                                // è®¡ç®—å›¾ç‰‡æ˜¾ç¤ºå°ºå¯¸
                                calculateImageDisplaySize();
                                updateImagePosition();
                                drawCoordinateSystem();
                                
                                console.log('å›¾ç‰‡åŠ è½½å®Œæˆ:', {
                                    width: config.imageOriginalWidth,
                                    height: config.imageOriginalHeight,
                                    src: shipImage.src.substring(0, 50) + '...'
                                });
                            };
                            
                            shipImage.onerror = (error) => {
                                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                                alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                            };
                        };
                        reader.readAsArrayBuffer(file); // ä½¿ç”¨ArrayBufferè€Œä¸æ˜¯DataURL
                    }
                };
                
                input.click();
            });

            // é‡ç½®å›¾ç‰‡æŒ‰é’®äº‹ä»¶
            if (imageResetBtn) {
                imageResetBtn.addEventListener('click', resetImage);
            }

            // å›¾ç‰‡å°ºå¯¸æ§åˆ¶äº‹ä»¶
            document.getElementById('imageLength').addEventListener('input', updateImageSize);
            document.getElementById('imageLength').addEventListener('change', updateImageSize);
            document.getElementById('imageWidth').addEventListener('input', updateImageSize);
            document.getElementById('imageWidth').addEventListener('change', updateImageSize);

            document.getElementById('lockAspectRatio').addEventListener('change', (e) => {
                config.lockAspectRatio = e.target.checked;
                if (config.hasImage) {
                    updateImageSize();
                }
            });

            document.getElementById('autoFitImage').addEventListener('change', (e) => {
                config.autoFitImage = e.target.checked;
                if (config.hasImage) {
                    if (config.autoFitImage) {
                        // åˆ‡æ¢åˆ°è‡ªåŠ¨é€‚åº”æ¨¡å¼ï¼Œé‡æ–°è®¡ç®—å°ºå¯¸
                        calculateImageDisplaySize();
                    }
                    updateImagePosition();
                }
            });

            document.getElementById('centerImage').addEventListener('change', (e) => {
                config.centerImage = e.target.checked;
                if (config.hasImage) {
                    updateImagePosition();
                }
            });

            document.getElementById('resetImageSizeBtn').addEventListener('click', () => {
                if (!config.hasImage) return;
                
                // é‡ç½®ä¸ºèˆ¹åªå°ºå¯¸
                config.imageLength = parseFloat(document.getElementById('shipLength').value);
                config.imageWidth = parseFloat(document.getElementById('shipWidth').value);
                
                // æ›´æ–°UI
                document.getElementById('imageLength').value = config.imageLength;
                document.getElementById('imageWidth').value = config.imageWidth;
                
                // é‡æ–°è®¡ç®—æ˜¾ç¤ºå°ºå¯¸
                calculateImageDisplaySize();
                updateImagePosition();
            });

            document.getElementById('imageScaleUpBtn').addEventListener('click', () => {
                if (!config.hasImage) return;
                
                // å…³é—­è‡ªåŠ¨é€‚åº”ï¼ˆå› ä¸ºè¦æ‰‹åŠ¨ç¼©æ”¾ï¼‰
                config.autoFitImage = false;
                document.getElementById('autoFitImage').checked = false;
                
                // æ‰‹åŠ¨æ”¾å¤§å›¾ç‰‡
                config.imageScale *= 1.2;
                updateImagePosition();
            });

            document.getElementById('imageScaleDownBtn').addEventListener('click', () => {
                if (!config.hasImage) return;
                
                // å…³é—­è‡ªåŠ¨é€‚åº”ï¼ˆå› ä¸ºè¦æ‰‹åŠ¨ç¼©æ”¾ï¼‰
                config.autoFitImage = false;
                document.getElementById('autoFitImage').checked = false;
                
                // æ‰‹åŠ¨ç¼©å°å›¾ç‰‡
                config.imageScale /= 1.2;
                updateImagePosition();
            });

            document.getElementById('clearAllBtn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ¨¡å—å—ï¼Ÿ')) {
                    config.modules = [];
                    config.selectedModule = null;
                    if (moduleEditor) moduleEditor.classList.add('hidden');
                    updateModuleList();
                    drawCoordinateSystem();
                }
            });

            document.getElementById('addModuleBtn').addEventListener('click', () => {
                addModule(0, 0);
            });

            document.getElementById('addArmamentBtn').addEventListener('click', () => {
                config.currentModuleType = 'armament';
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('addArmamentBtn').classList.add('active');
            });

            document.getElementById('addTurretBtn').addEventListener('click', () => {
                config.currentModuleType = 'turret';
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('addTurretBtn').classList.add('active');
            });

            document.getElementById('saveModuleBtn').addEventListener('click', updateModule);
            document.getElementById('deleteModuleBtn').addEventListener('click', deleteModule);
            document.getElementById('generateCodeBtn').addEventListener('click', generateShipCode);

            // æ¨¡å—ç±»å‹æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.module-type-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.module-type-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const type = tab.dataset.type;
                    if (type === 'armament') {
                        config.currentModuleType = 'armament';
                        document.getElementById('addArmamentBtn').click();
                    } else if (type === 'turret') {
                        config.currentModuleType = 'turret';
                        document.getElementById('addTurretBtn').click();
                    }
                });
            });

            // èˆ¹åªå°ºå¯¸å˜åŒ–æ—¶ï¼ŒåŒæ­¥æ›´æ–°å›¾ç‰‡å°ºå¯¸ï¼ˆå¦‚æœå¼€å¯äº†è‡ªåŠ¨åŒæ­¥ï¼‰
            document.getElementById('shipLength').addEventListener('change', () => {
                if (config.hasImage && config.autoFitImage) {
                    config.imageLength = parseFloat(document.getElementById('shipLength').value);
                    document.getElementById('imageLength').value = config.imageLength;
                    calculateImageDisplaySize();
                    updateImagePosition();
                }
            });

            document.getElementById('shipWidth').addEventListener('change', () => {
                if (config.hasImage && config.autoFitImage) {
                    config.imageWidth = parseFloat(document.getElementById('shipWidth').value);
                    document.getElementById('imageWidth').value = config.imageWidth;
                    calculateImageDisplaySize();
                    updateImagePosition();
                }
            });

            // åˆå§‹åŒ–
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            drawCoordinateSystem();
            updateModuleList();
            
            console.log('èˆ¹åªå»ºé€ å·¥å…·åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>